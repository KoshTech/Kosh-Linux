# Kosh Linux Package File
# Specification at: http://koshlinux.com/

info:
  name: Re-adjusting the Toolchain
  version: 0.0.7
  homepage: http://www.linuxfromscratch.org/lfs/view/stable/chapter05/adjusting.html
  description: "Now that the final C libraries have been installed, it is time to adjust the toolchain again. The toolchain will be adjusted so that it will link any newly compiled program against these new libraries."
  
fetch:
  do: no
  
unpack:
  do: no

configure:
  do: no

make:
  do: no

make_install:
  chroot: true
  do: |
    cp -v /tools/bin/{ld,ld-old}
    cp -v /tools/$(gcc -dumpmachine)/bin/{ld,ld-old}
    cp -v /tools/bin/{ld-new,ld}
    ln -sfv /tools/bin/ld /tools/$(gcc -dumpmachine)/bin/ld
    gcc -dumpspecs | sed -e 's@/tools@@g' \
    -e '/\*startfile_prefix_spec:/{n;s@.*@/usr/lib/ @}' \
    -e '/\*cpp:/{n;s@$@ -isystem /usr/include@}' > \
    `dirname $(gcc --print-libgcc-file-name)`/specs
    echo 'main(){}' > dummy.c
    cc dummy.c -v -Wl,--verbose &> dummy.log
    readelf -l a.out | grep ': /lib'
    grep -o '/usr/lib.*/crt[1in].*succeeded' dummy.log
    grep -B1 '^ /usr/include' dummy.log
    grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'
    grep "/lib.*/libc.so.6 " dummy.log
    grep found dummy.log
    rm -v dummy.c a.out dummy.log
